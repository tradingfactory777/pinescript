// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © TradingFactory_

//@version=6
strategy('Project 3: BBands & Stochastic Strategy', overlay = false, process_orders_on_close = true, pyramiding = 100, margin_long = 0, margin_short = 0, default_qty_type = strategy.percent_of_equity, default_qty_value = 10)

// Inputs
bb_length = input.int(20, 'BB Length')
bb_mult = input.float(2.0, 'BB StdDev')
stoch_k_length = input.int(14, 'Stoch %K Length')
stoch_d_length = input.int(3, 'Stoch %D Length')
stoch_smooth = input.int(3, 'Stoch Smoothing')
stoch_overbought = input.int(80, 'Stoch Overbought')
stoch_oversold = input.int(20, 'Stoch Oversold')

// Calculate Indicators
[middle, upper, lower] = ta.bb(close, bb_length, bb_mult)
range123 = (upper - lower) / 10

stoch_k = ta.stoch(close, high, low, stoch_k_length)
stoch_d = ta.sma(stoch_k, 9)

highest = ta.highest(1000)
lowest = ta.lowest(1000)
middle_price = (highest + lowest) / 2

// Define Trading Conditions
longCondition1 = ta.crossover(close, lower)
longCondition2 = ta.crossover(stoch_k, stoch_d)
longCondition3 = middle_price > close
longCondition4 = lower - range123 < close and close < lower + range123
longCondition5 = nz(strategy.opentrades.entry_price(strategy.opentrades - 1), high + 1) > close
longCondition_final = longCondition1 and longCondition2 and longCondition3 and longCondition4 and longCondition5

longCloseCondition_final = ta.crossunder(stoch_k, stoch_d)

shortCondition1 = ta.crossunder(close, upper)
shortCondition2 = ta.crossunder(stoch_k, stoch_d)
shortCondition3 = middle_price < close
shortCondition4 = upper - range123 < close and close < upper + range123
shortCondition5 = nz(strategy.opentrades.entry_price(strategy.opentrades - 1), high + 1) < close
shortCondition = shortCondition1 and shortCondition2 and shortCondition3 and shortCondition4 and shortCondition5

// Execute Trades
if longCondition_final
    strategy.entry('Buy', strategy.long)


if strategy.position_avg_price * 1.01 < close or (strategy.opentrades > 2 and strategy.position_avg_price < close)
    strategy.close_all()
    // strategy.entry('Sell', strategy.short)

// Plot Indicators
plot(upper, 'Upper BB', color.white, force_overlay = true)
plot(lower, 'Lower BB', color.white, force_overlay = true)

// Visuals for Overbought/Oversold zones
plot(stoch_k, color = color.white)
plot(stoch_d, color = color.yellow)
plot(stoch_overbought, 'Overbought', color.red)
plot(stoch_oversold, 'Oversold', color.teal)
